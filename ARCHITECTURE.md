# 项目架构说明

## 概述

临时邮箱API服务基于Flask框架构建，通过SMTP.dev API提供临时邮箱功能。项目采用模块化设计，各组件职责明确。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    API客户端应用                            │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │   Flask API     │  │         邮件客户端              │  │
│  │   (app.py)      │  │      (mail_client.py)           │  │
│  └─────────────────┘  └─────────────────────────────────┘  │
│           │                         │                      │
│           ▼                         ▼                      │
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │  账户缓存管理   │  │     SMTP.dev API 客户端         │  │
│  │ (线程安全字典)  │  │      (smtp_api.py)              │  │
│  └─────────────────┘  └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
                   ┌─────────────┐
                   │ SMTP.dev API│
                   │  服务接口   │
                   └─────────────┘
```

## 核心组件

### 1. Flask API服务 (app.py)

- 提供RESTful API接口
- 处理HTTP请求和响应
- 管理邮件客户端实例缓存
- 确保线程安全的并发访问

### 2. 邮件客户端 (mail_client.py)

- 封装邮箱账户管理逻辑
- 实现邮件等待和获取功能
- 跟踪已处理邮件，避免重复处理
- 提供向后兼容的接口

### 3. SMTP.dev API客户端 (smtp_api.py)

- 封装所有SMTP.dev API调用
- 处理认证和请求头设置
- 提供统一的错误处理
- 实现重试和超时机制

### 4. 配置管理 (config.py)

- 读取环境变量配置
- 提供类型安全的配置访问
- 集中管理所有配置项

### 5. 用户名生成器 (username_generator.py)

- 生成随机用户名
- 支持多种命名模式
- 确保用户名唯一性

## 数据流向

1. **创建账户请求**：
   - 用户发送POST请求到`/api/email`
   - Flask API解析请求参数
   - 创建或复用MailTmClient实例
   - 通过SMTP.dev API创建新账户
   - 返回账户信息给用户

2. **获取邮件请求**：
   - 用户发送GET请求到`/api/email/{email}`
   - Flask API查找或创建MailTmClient实例
   - MailTmClient轮询等待新邮件
   - 通过SMTP.dev API获取邮件列表
   - 返回新邮件内容给用户

## 缓存机制

- 使用线程安全字典存储邮件客户端实例
- 避免重复创建相同邮箱的客户端
- 提高API响应速度
- 减少对SMTP.dev API的调用次数

## 安全设计

- 敏感信息通过环境变量管理
- API密钥不硬编码在代码中
- 使用HTTPS与SMTP.dev API通信
- 输入验证和错误处理

## 扩展性考虑

- 模块化设计便于功能扩展
- 接口抽象支持替换邮件服务提供商
- 配置驱动便于部署不同环境
- 日志记录支持问题排查